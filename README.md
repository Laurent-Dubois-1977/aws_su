# A simple script to switch AWS CLI profiles 


If you are like me and have access to too many AWS accounts, switching from one AWS credentials profile to another can be tedious when using the AWS CLI. So, to save time and avoid mistakes, I put together a simple bash script to easily switch between profiles.

# TL,DR: what’s that doodad?

-	The script runs on bash and most other Linux-based shells 
-	The script shows you the different profiles on your AWS CLI credential file 
-	You choose the profile 
-	The profile loads 
-	You saved a few seconds of your time and feel much more efficient (at least I do)



# Prerequisite

This script is written for bash but will run on most Linux-based shells. It requires Perl. Most Linux distributions already have Perl pre-installed, and if you are using it on a mac, you can install it following the simple instructions here (https://learn.perl.org/installing/) 

There is likely a way to run the script on Windows as well, but I haven’t done so yet. However, I am sure it can be done easily, and I will update this page as soon as I try.

# How does it work

If you found this page, I assume you already know about the AWS CLI and the programmatic access credentials to an AWS account. 

If not, a short version to get you started is as follows:

-	The AWS CLI allows you to manage AWS resources based on IAM credentials set up by an AWS account administrator.
-	Credentials are generated by the admin of the AWS account (or someone who has the proper privilege) 
-	The credentials are stored in a file aptly named “credentials” which is stored on your computer and read by the AWS CLI when running a command
-	The credentials are stored in this file under the following format (example below for two profiles named “default” and “AWS_account1”):
```
[default] 
aws_access_key_id = <your key here>
aws_secret_access_key = <your secret here>

[AWS_account1] 
aws_access_key_id = <your other key here>
aws_secret_access_key = <your  other secret here>

```
-	To use the proper credentials, you need to define the environment variable of your shell as `AWS_PROFILE=<the profile of your choice>`
-	From there, the AWS CLI use the profile you selected 

So, switching from one profile to another is as simple as running the following command:
` export AWS_PROFILE=<the profile you need>`

However, when you have access to dozens of profiles, this can be a pain to do as you likely don’t remember all the profile names you have (at least I don’t, but perhaps I am getting old)

Therefore, I put together a simple script to help switch between one profile and another quickly and without too much typing.

The script reads the credentials file, shows you the list of profiles you have saved on the file, and allows you to load the profile by selecting it on the shell. Simple… so simple I am sure I am not the first to come up with this. If you have a better script, please let me know. 


## The script and setup

```
#!/bin/bash

profiles=($(perl -lne '/\[\K[^\]]+/ and print $&' <PATH TO YOUR CREDENTIALS FILE>))
PS3='Profile number: '

export AWS_SHARED_CREDENTIALS_FILE=<PATH TO YOUR CREDENTIALS FILE>

echo " "
echo "-------------------------------"
echo "Please select a profile to load"
echo "-------------------------------"

select choice in "${profiles[@]}"
do
    export AWS_PROFILE=$choice
    echo "-------------------------------"
    echo "AWS CLI profile set to "$choice    
    echo "-------------------------------"
    echo " "
    break
done


```
And voila! Simple and hopefully as useful to you as to me. 

### Setup instructions

1.	Create a file (with any text editor) and paste the script into the new file
2.	Replace the <PATH TO YOUR CREDENTIALS FILE> sections with the path to your AWS CLI credential file. By default it is under ` ~/.aws/credentials` on Linux and Mac. 
3.	Save the file as `aws_profile_select.sh`
4.	In a terminal, navigate to the folder where you saved the file and run `chmod 775 aws_profile_select.sh`  on the file to make it executable
5.	Try the script  by running `./aws_profile_select.sh` in the terminal

### Additional step (optional)

**Setup an alias** 

I run this script using an alias pointing to the script. This saves me at least another two lines of shell commands. I setup the alias as ` awssu='source <path to the script>/aws_profile_select.sh'`.
I chose `awssu` because it's easy to remember if you are used to the `su` command in Linux which switch users. You can come up with any alias you like. 

Please refer to your shell documentation to set up aliases and make them persistent. 

## A note on credentials security

I never liked the default location of the credentials files for AWS to be on the computer I run the CLI. Call me paranoid but storing the credentials to resources on AWS in plain text on a laptop always gave me goosebumps. I know there are many ways to go around this and proper production environment practice should limit all programmatic access to only a few trusted IP addresses and users. However, I keep on coming across companies who still have their AWS account root user using the founder’s dog name and birthdate as password, so the credentials saved in an unencrypted file is still a step above this. But I digress…

As far as I am concerned, I always have the AWS CLI credentials file on a USB drive which I connect when I need to use the CLI. The path to the file I use in my script is to that USB drive. The drive itself is encrypted. I use a fancy external drive with biometrics to secure this (don’t trust all biometric drives though… they are mostly a gimmick), and there are several other levels of security I use to protect the credentials files, such as encrypting the file itself and running all kinds of scripts to decrypt them when needed and clean up after usage.

In other words, be careful with this file. Keep it on your computer hard drive if you wish but remember that if you have full admin privilege through the  AWS CLI,  anyone who gets a hold of that file can start any resources on your AWS account, and you may have to pay for a bitcoin mining operation on your next AWS invoice. 


## Final note
This script is very simple and, if anything, I hope it introduced some of you to how we can easily use bash scripts to make our lives easier on day-to-day operations. 

As I got to the point where I needed to access dozens of AWS accounts and profiles to manage different systems on different environments, I took a few minutes to put this script together and it saved me a lot of headaches and time.

As final note, the credentials in the file can be named as you wish (just keep one named as [default]) so I usually have a taxonomy for the profile names. I generally use the system name, environment, and basic description of the access level for profile names as in the following example:  `ACMEERP_PROD_ADMIN`. 

I hope this will be helpful to you. If you have any questions or suggestions, please email me, or leave a comment. 


 








